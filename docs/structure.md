# Структура проекта KION Event Deduplicator

## Корневые директории и файлы

```
KION-ver-2.5/
├── app/              # Основной код приложения
├── docs/             # Документация проекта
├── logs/             # Логи работы системы
├── tests/            # Тесты, включая нагрузочное тестирование
├── docker-compose.yml # Конфигурация Docker-контейнеров
├── Dockerfile        # Инструкции для сборки Docker-образа
├── requirements.txt  # Зависимости Python
├── .env              # Переменные окружения
├── index.html        # Корневая страница веб-интерфейса
└── README.md         # Общее описание проекта
```

## Детальное описание директорий

### Директория `app/`

Содержит основной код приложения:

```
app/
├── __init__.py       # Инициализация модуля приложения
├── main.py           # Основной файл, точка входа приложения
├── models.py         # Модели данных Pydantic
├── deduplicator.py   # Логика дедупликации событий
├── api/              # API эндпоинты
│   ├── __init__.py
│   ├── events.py     # Обработка событий
│   └── ui.py         # Веб-интерфейс
├── services/         # Служебные сервисы
│   ├── __init__.py
│   ├── kafka_service.py    # Взаимодействие с Kafka
│   ├── postgres_service.py # Взаимодействие с PostgreSQL
│   └── redis_service.py    # Взаимодействие с Redis
├── consumers/        # Потребители данных из Kafka
│   ├── __init__.py
│   └── event_consumer.py   # Потребитель событий
├── static/           # Статические файлы
└── templates/        # HTML-шаблоны
```

### Директория `tests/`

Содержит тесты системы:

```
tests/
└── load/             # Нагрузочное тестирование
    └── locustfile.py # Сценарии нагрузочного тестирования
```

## Ключевые файлы и их назначение

### Файл `app/main.py`

Главный файл приложения:

- Инициализирует FastAPI приложение
- Настраивает middleware
- Подключает маршрутизаторы API
- Устанавливает соединения с Redis, Kafka и PostgreSQL
- Запускает обработчики событий

### Файл `app/deduplicator.py`

Реализует ядро дедупликации:

- Вычисляет хеши событий
- Проверяет наличие дубликатов в Redis
- Определяет шард для хранения события

### Файл `app/models.py`

Определяет модели данных:

- `EventModel` - структура входящего события
- `DedupResult` - результат проверки на дубликат
- `EventProcessingResponse` - ответ API на обработку события

### Файл `app/api/events.py`

API для работы с событиями:

- Эндпоинт `/api/event` для приема событий
- Эндпоинты для получения статистики и экспорта данных
- Проверка состояния сервисов

### Файл `app/api/ui.py`

API для веб-интерфейса:

- Эндпоинты для отображения состояния базы данных
- Эндпоинты для отображения статистики дедупликации

### Файл `app/services/redis_service.py`

Сервис для работы с Redis:

- Устанавливает соединение с Redis
- Обеспечивает хранение и проверку хешей событий
- Поддерживает шардирование Redis

### Файл `app/services/postgres_service.py`

Сервис для работы с PostgreSQL:

- Устанавливает соединение с PostgreSQL
- Создает необходимые таблицы и индексы
- Сохраняет уникальные события
- Извлекает события для API
- Поддерживает шардирование PostgreSQL

### Файл `app/services/kafka_service.py`

Сервис для работы с Kafka:

- Подключается к Kafka
- Отправляет события в топик
- Поддерживает настройки продюсера

### Файл `app/consumers/event_consumer.py`

Потребитель событий из Kafka:

- Получает события из Kafka
- Обрабатывает события асинхронно
- Сохраняет события в PostgreSQL
